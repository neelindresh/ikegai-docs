document.addEventListener("DOMContentLoaded", function() {
    // Initialize Mermaid but prevent it from auto-running
    mermaid.initialize({ startOnLoad: false, theme: 'default' });
    
    // Find all the protected code blocks generated by MkDocs
    document.querySelectorAll('pre > code.mermaid').forEach((codeBlock, index) => {
        // Extract the pristine, untouched text
        const text = codeBlock.textContent;
        
        // Create a new div to hold the rendered SVG
        const div = document.createElement('div');
        div.className = 'mermaid-rendered'; 
        
        // Replace the original code block with our new div
        codeBlock.parentNode.replaceWith(div);
        
        // Render the graph and inject the clean SVG
        mermaid.render('mermaid-chart-' + index, text).then((result) => {
            div.innerHTML = result.svg;
        }).catch((err) => {
            console.error(err);
            div.innerHTML = `<div style="color: red; padding: 1rem; border: 1px dashed red;">Mermaid Syntax Error - Check console for details.</div>`;
        });
    });
});